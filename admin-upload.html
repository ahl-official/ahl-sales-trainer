<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Upload Content | AHL Sales Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        indigo: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                        },
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.6);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-600">
    <!-- Header -->
    <header class="glass-header fixed top-0 w-full z-40 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-200">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900 tracking-tight">Admin Console</h1>
                    <div class="flex items-center gap-2 text-xs font-medium text-slate-500">
                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        <span id="admin-name">Administrator</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <a href="admin-dashboard.html" class="flex items-center gap-2 px-4 py-2 bg-white text-slate-600 rounded-xl border border-slate-200 hover:bg-slate-50 hover:text-indigo-600 transition-all text-sm font-semibold shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"/></svg>
                    Back to Dashboard
                </a>
                <button id="logout-btn" class="flex items-center gap-2 px-4 py-2 bg-rose-50 text-rose-600 rounded-xl border border-rose-100 hover:bg-rose-100 transition-all text-sm font-semibold">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mt-24">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Column: Upload Form (8 cols) -->
            <div class="lg:col-span-8 space-y-8">
                <div class="glass-card rounded-2xl shadow-sm p-8">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="p-3 bg-indigo-50 rounded-xl text-indigo-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Upload Content</h2>
                            <p class="text-slate-500">Add new training materials to the knowledge base</p>
                        </div>
                    </div>
                    
                    <form id="upload-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="category" class="text-sm font-semibold text-slate-700">Category</label>
                                <div class="relative">
                                    <select id="category" required class="w-full appearance-none pl-4 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all">
                                        <option value="">Select Category...</option>
                                        <option value="Pre Consultation">Pre Consultation</option>
                                        <option value="Consultation Series">Consultation Series</option>
                                        <option value="Sales Objections">Sales Objections</option>
                                        <option value="After Fixing Objection">After Fixing Objection</option>
                                        <option value="Full Wig Consultation">Full Wig Consultation</option>
                                        <option value="Hairline Consultation">Hairline Consultation</option>
                                        <option value="Types of Patches">Types of Patches</option>
                                        <option value="Upselling / Cross Selling">Upselling / Cross Selling</option>
                                        <option value="Retail Sales">Retail Sales</option>
                                        <option value="SMP Sales">SMP Sales</option>
                                        <option value="Sales Follow up">Sales Follow up</option>
                                        <option value="General Sales">General Sales</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label for="video-name" class="text-sm font-semibold text-slate-700">Video Name</label>
                                <input type="text" id="video-name" required placeholder="e.g., Sales Script Mastery" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder:text-slate-400">
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label for="file-input" class="text-sm font-semibold text-slate-700">Transcript File (.txt)</label>
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-200 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-all group">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-3 text-slate-400 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                    <p class="mb-2 text-sm text-slate-500"><span class="font-semibold text-indigo-600">Click to upload</span> or drag and drop</p>
                                    <p class="text-xs text-slate-400" id="file-name-display">TXT files only</p>
                                </div>
                                <input id="file-input" type="file" class="hidden" accept=".txt" required />
                            </label>
                        </div>
                        
                        <div class="flex items-center gap-3 p-4 bg-indigo-50/50 border border-indigo-100 rounded-xl text-sm text-indigo-700">
                            <svg class="w-5 h-5 text-indigo-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <p>Files will be automatically chunked and indexed in Pinecone for AI retrieval.</p>
                        </div>
                        
                        <button type="submit" id="upload-btn" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                            <span>Upload to Knowledge Base</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        </button>
                    </form>
                    
                    <!-- Upload Progress -->
                    <div id="upload-status" class="mt-6 hidden">
                        <div class="p-5 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="flex justify-between text-sm font-medium mb-2">
                                <span id="status-text" class="text-slate-700">Processing...</span>
                                <span class="text-indigo-600 animate-pulse">Please wait</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden">
                                <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="upload-result" class="mt-6 hidden"></div>
                </div>
            </div>

            <!-- Right Column: Stats & Create User (4 cols) -->
            <div class="lg:col-span-4 space-y-8">
                
                <!-- Create User Card -->
                <div class="glass-card rounded-2xl shadow-sm p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                        </div>
                        <h2 class="text-lg font-bold text-slate-900">Add Candidate</h2>
                    </div>
                    
                    <form id="create-user-form" class="space-y-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Username</label>
                            <input type="text" id="new-username" required placeholder="e.g. rahul.kumar" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
                        </div>
                        
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Password</label>
                            <input type="password" id="new-password" required placeholder="••••••••" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
                        </div>
                        
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Full Name</label>
                            <input type="text" id="new-name" required placeholder="Rahul Kumar" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
                        </div>
                        
                        <button type="submit" id="create-user-btn" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl shadow-lg shadow-emerald-200 transition-all active:scale-[0.98] text-sm">
                            Create Account
                        </button>
                    </form>
                    <div id="user-result" class="mt-4 hidden text-sm"></div>
                </div>

                <!-- Stats Card -->
                <div class="glass-card rounded-2xl shadow-sm p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        </div>
                        <h2 class="text-lg font-bold text-slate-900">Content Status</h2>
                    </div>
                    
                    <div id="stats-loading" class="flex flex-col items-center justify-center py-8 text-slate-400">
                        <div class="animate-spin rounded-full h-8 w-8 border-2 border-slate-200 border-t-indigo-600 mb-3"></div>
                        <span class="text-xs">Syncing data...</span>
                    </div>
                    
                    <div id="stats-container" class="space-y-3 hidden max-h-[400px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-slate-200"></div>
                </div>

            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <script>
        // Toast System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let icon = '';
            let colors = 'bg-slate-800 text-white';
            
            if (type === 'success') {
                colors = 'bg-white border-l-4 border-emerald-500 text-slate-800 shadow-xl shadow-emerald-100';
                icon = '<svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
            }
            if (type === 'error') {
                colors = 'bg-white border-l-4 border-rose-500 text-slate-800 shadow-xl shadow-rose-100';
                icon = '<svg class="w-5 h-5 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
            }
            if (type === 'warning') {
                colors = 'bg-white border-l-4 border-amber-500 text-slate-800 shadow-xl shadow-amber-100';
                icon = '<svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
            }
            
            toast.className = `pointer-events-auto min-w-[300px] max-w-md p-4 rounded-xl flex items-start gap-3 transform transition-all duration-500 translate-y-10 opacity-0 ${colors}`;
            toast.innerHTML = `
                <div class="mt-0.5">${icon}</div>
                <div class="flex-1">
                    <p class="text-sm font-medium leading-5">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            
            container.appendChild(toast);
            
            requestAnimationFrame(() => toast.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // File input enhancement
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length > 0) {
                fileNameDisplay.textContent = e.target.files[0].name;
                fileNameDisplay.classList.add('text-indigo-600', 'font-medium');
                fileNameDisplay.classList.remove('text-slate-400');
            } else {
                fileNameDisplay.textContent = 'TXT files only';
                fileNameDisplay.classList.remove('text-indigo-600', 'font-medium');
                fileNameDisplay.classList.add('text-slate-400');
            }
        });

        const API_BASE = '';
        
        // Check authentication
        const user = JSON.parse(localStorage.getItem('ahl_user') || '{}');
        if (!user.id || user.role !== 'admin') {
            window.location.href = 'login.html';
        }
        
        document.getElementById('admin-name').textContent = user.name;
        
        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include',
                    keepalive: true
                });
            } catch (e) {
                console.warn('Logout fetch failed, but redirecting anyway:', e);
            }
            localStorage.removeItem('ahl_user');
            window.location.href = 'login.html';
        });
        
        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/categories`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                const container = document.getElementById('stats-container');
                container.innerHTML = '';
                
                data.categories.forEach(cat => {
                    const div = document.createElement('div');
                    const hasContent = cat.video_count > 0;
                    div.className = `p-3 rounded-xl border ${hasContent ? 'bg-white border-slate-200' : 'bg-slate-50 border-transparent'} flex items-center justify-between group hover:border-indigo-200 transition-colors`;
                    
                    div.innerHTML = `
                        <div>
                            <h3 class="text-sm font-semibold text-slate-700 group-hover:text-indigo-700 transition-colors">${cat.name}</h3>
                            <p class="text-xs text-slate-500 mt-0.5">
                                <span class="font-medium ${hasContent ? 'text-indigo-600' : ''}">${cat.video_count}</span> videos • 
                                <span class="font-medium ${hasContent ? 'text-indigo-600' : ''}">${cat.chunks}</span> chunks
                            </p>
                        </div>
                        <div class="h-6 w-6 rounded-full flex items-center justify-center ${hasContent ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-400'}">
                            ${hasContent ? '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>' : '<span class="text-xs font-bold">•</span>'}
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                document.getElementById('stats-loading').classList.add('hidden');
                container.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats-loading').innerHTML = '<span class="text-rose-500 text-xs">Failed to load stats</span>';
            }
        }
        
        loadStats();
        
        // Upload form
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const category = document.getElementById('category').value;
            const videoName = document.getElementById('video-name').value.trim();
            const file = document.getElementById('file-input').files[0];
            
            if (!file || !category || !videoName) {
                showToast('Please fill all fields', 'warning');
                return;
            }
            
            const uploadBtn = document.getElementById('upload-btn');
            const statusDiv = document.getElementById('upload-status');
            const statusText = document.getElementById('status-text');
            const progressBar = document.getElementById('progress-bar');
            const resultDiv = document.getElementById('upload-result');
            
            const originalContent = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"></div> Uploading...';
            statusDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            
            statusText.textContent = 'Reading file and creating embeddings...';
            progressBar.style.width = '30%';
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('category', category);
            formData.append('video_name', videoName);
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/upload`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                progressBar.style.width = '70%';
                const data = await response.json();
                progressBar.style.width = '100%';
                
                if (response.ok && data.success) {
                    statusText.textContent = 'Upload complete!';
                    resultDiv.className = 'mt-6 p-4 bg-emerald-50 border border-emerald-100 text-emerald-800 rounded-xl text-sm';
                    resultDiv.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="p-1 bg-emerald-100 rounded-full text-emerald-600 flex-shrink-0">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-emerald-900 mb-1">Upload Successful</h4>
                                <ul class="space-y-1 text-emerald-700/80">
                                    <li>Category: <span class="font-medium text-emerald-800">${data.category}</span></li>
                                    <li>Video: <span class="font-medium text-emerald-800">${data.video_name}</span></li>
                                    <li>Chunks: <span class="font-medium text-emerald-800">${data.chunks}</span></li>
                                </ul>
                            </div>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    showToast('Content uploaded successfully!', 'success');
                    
                    // Reset form
                    document.getElementById('upload-form').reset();
                    fileNameDisplay.textContent = 'TXT files only';
                    fileNameDisplay.classList.remove('text-indigo-600', 'font-medium');
                    fileNameDisplay.classList.add('text-slate-400');
                    
                    // Reload stats
                    loadStats();
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                statusText.textContent = 'Upload failed';
                progressBar.classList.remove('bg-indigo-600');
                progressBar.classList.add('bg-rose-500');
                
                resultDiv.className = 'mt-6 p-4 bg-rose-50 border border-rose-100 text-rose-800 rounded-xl text-sm';
                resultDiv.innerHTML = `
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-rose-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <div>
                            <strong class="block font-bold text-rose-900">Upload Failed</strong>
                            ${error.message}
                        </div>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                showToast('Upload failed: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalContent;
                
                // Hide progress bar after delay if success
                if(statusText.textContent === 'Upload complete!') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                        progressBar.style.width = '0%';
                    }, 3000);
                }
            }
        });
        
        // Create user form
        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const name = document.getElementById('new-name').value.trim();
            
            const btn = document.getElementById('create-user-btn');
            const resultDiv = document.getElementById('user-result');
            
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div> Creating...';
            
            try {
                const usernameValid = username.length >= 3 && /^[a-zA-Z0-9._-]+$/.test(username);
                const passwordValid = password.length >= 6;
                const nameValid = name.length >= 2;
                if (!usernameValid || !passwordValid || !nameValid) {
                    const messages = [];
                    if (!usernameValid) messages.push('Username: 3+ chars, letters/nums only');
                    if (!passwordValid) messages.push('Password: 6+ chars');
                    if (!nameValid) messages.push('Name: 2+ chars');
                    throw new Error(messages.join('<br>'));
                }
                const response = await fetch(`${API_BASE}/api/admin/users`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, name })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'mt-4 p-3 bg-emerald-50 border border-emerald-100 text-emerald-800 rounded-xl';
                    resultDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            <span>Created: <strong>${data.username}</strong></span>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    showToast('Candidate account created successfully', 'success');
                    
                    document.getElementById('create-user-form').reset();
                } else {
                    if (data && Array.isArray(data.errors)) {
                        const msg = data.errors.map(e => `${e.field}: ${e.message}`).join('; ');
                        throw new Error(msg);
                    }
                    throw new Error(data.message || data.error || 'Creation failed');
                }
            } catch (error) {
                console.error('User creation error:', error);
                resultDiv.className = 'mt-4 p-3 bg-rose-50 border border-rose-100 text-rose-800 rounded-xl';
                resultDiv.innerHTML = `<div class="font-medium text-xs">${error.message}</div>`;
                resultDiv.classList.remove('hidden');
                showToast('Failed to create user', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    </script>
</body>
</html>